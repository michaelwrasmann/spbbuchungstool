<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPB DESKSHARING</title>

  <style>
    :root{
      /* Modern Dark Theme Colors */
      --primary-neon:#00ff88;
      --primary-purple:#8b5cf6;
      --primary-blue:#06b6d4;
      --primary-pink:#ec4899;
      --accent-gold:#f59e0b;
      
      /* Dark Mode Base */
      --bg-dark:#0a0a0a;
      --bg-gradient:linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f1a 100%);
      --surface-glass:rgba(255, 255, 255, 0.05);
      --surface-glass-hover:rgba(255, 255, 255, 0.1);
      --surface-dark:rgba(0, 0, 0, 0.3);
      
      /* Glass Effects */
      --glass-border:1px solid rgba(255, 255, 255, 0.1);
      --glass-shadow:0 8px 32px rgba(0, 0, 0, 0.3);
      --glass-blur:backdrop-filter: blur(12px);

      /* Legacy compatibility */
      --primary-green:#04F498;
      --primary-green-dark:#03D389;
      --primary-red:#FF7597;
      --primary-gray:#aaa;
      --background:#B0F5EC;
      --text-color:#4027FD;
      --default-text:#000;
      --border-color:#e0e0e0;
      --modal-bg:rgba(0,0,0,.5);
      --border-radius:8px;
    }

    body{
      background: var(--bg-gradient);
      margin:0 20px 20px;
      color:var(--primary-neon);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Animated particle background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 20%, rgba(0, 255, 136, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 60%, rgba(6, 182, 212, 0.1) 0%, transparent 50%);
      animation: particleFloat 20s ease-in-out infinite;
      pointer-events: none;
      z-index: -1;
    }

    @keyframes particleFloat {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(30px, -30px) rotate(120deg); }
      66% { transform: translate(-20px, 20px) rotate(240deg); }
    }

    /* ---------- Clean Header Images ---------- */
    .headerImage{
      display:block;
      margin:5px auto -20px;
      max-width:420px;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .midImage{
      display:block;
      margin:-20px auto -20px;
      max-width:420px;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .headerImage:hover,.midImage:hover{
      transform:translateY(-2px) scale(1.01);
    }

    /* ---------- Clean Room Selection ---------- */
    .container{
      margin:-20px auto -20px;
      max-width:900px;
      text-align:center;
      position:relative;
      padding:5px;
    }
    svg{
      margin:0 auto;
      display:block;
      width:720px;
      height:200px;
      filter:drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
    }
    .roomGroup{
      transform-box:fill-box;
      transform-origin:center;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .roomGroup:hover{
      transform:translateY(-3px) scale(1.08);
      filter:drop-shadow(0 8px 25px rgba(0, 255, 136, 0.4));
    }
    .roomGroup rect{
      cursor:pointer;
      transition:all 0.3s ease;
      filter:drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
    }
    .roomGroup text{
      font-weight:bold;
      fill:var(--bg-dark)!important;
      pointer-events:none;
      font-size:14px;
      text-shadow:0 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* ---------- Modern Glass Preview ---------- */
    #preview{
      position:absolute;
      background:var(--surface-glass);
      backdrop-filter:blur(20px);
      border:var(--glass-border);
      border-radius:20px;
      padding:15px;
      z-index:1000;
      display:none;
      opacity:0;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:var(--glass-shadow);
    }
    #preview::before{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(139, 92, 246, 0.1));
      border-radius:20px;
      pointer-events:none;
    }
    #preview img{
      border-radius:16px;
      box-shadow:0 8px 32px rgba(0, 0, 0, 0.3);
      transition:transform 0.3s ease;
      position:relative;
      z-index:1;
    }
    #preview img:hover{
      transform:scale(1.02);
    }

    /* ---------- Modern Glass Calendar ---------- */
    .calendarWrapper{
      margin-top:-15px;
      padding:10px;
    }
    .weekNav{
      text-align:center;
      margin:30px 0;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:20px;
    }
    .weekNav button{
      padding:12px 24px;
      font-size:14px;
      border:none;
      border-radius:12px;
      background:var(--surface-glass);
      color:var(--primary-neon);
      font-weight:600;
      cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter:blur(12px);
      border:var(--glass-border);
      box-shadow:var(--glass-shadow);
      position:relative;
      overflow:hidden;
    }
    .weekNav button::before{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(45deg, var(--primary-neon), var(--primary-purple));
      opacity:0;
      transition:opacity 0.3s ease;
    }
    .weekNav button:hover::before{
      opacity:0.1;
    }
    .weekNav button:hover{
      transform:translateY(-2px) scale(1.05);
      box-shadow:0 12px 40px rgba(0, 255, 136, 0.3);
      border-color:var(--primary-neon);
    }
    #weekLabel{
      color:var(--primary-neon);
      font-weight:600;
      font-size:18px;
      text-shadow:0 0 10px rgba(0, 255, 136, 0.5);
    }

    .calendarContainer{
      position:relative;
      width:fit-content;
      margin:0 auto;
      background:var(--surface-glass);
      backdrop-filter:blur(12px);
      border-radius:20px;
      border:var(--glass-border);
      box-shadow:var(--glass-shadow);
      padding:20px;
    }
    #weekTable{
      border-collapse:separate;
      border-spacing:8px;
      width:864px;
      table-layout:fixed;
      position:relative;
      z-index:2;
      background:transparent;
    }
    #weekTable thead tr:nth-child(1) th,
    #weekTable thead tr:nth-child(2) th{
      border:none;
      padding:12px;
      text-align:center;
      vertical-align:middle;
      background:var(--surface-glass-hover);
      font-weight:600;
      color:var(--primary-neon);
      border-radius:12px;
      border:1px solid rgba(0, 255, 136, 0.2);
      backdrop-filter:blur(8px);
      box-shadow:0 4px 16px rgba(0, 255, 136, 0.1);
    }
    #weekTable tbody th{
      padding:12px;
      text-align:center;
      vertical-align:middle;
      background:var(--surface-glass-hover);
      font-weight:600;
      color:var(--primary-purple);
      border-radius:12px;
      white-space:nowrap;
      border:1px solid rgba(139, 92, 246, 0.2);
      backdrop-filter:blur(8px);
      box-shadow:0 4px 16px rgba(139, 92, 246, 0.1);
    }
    #weekTable tbody td{
      border:none;
      padding:12px;
      text-align:center;
      vertical-align:middle;
      overflow:hidden;
      white-space:nowrap;
      border-radius:12px;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight:600;
      color:var(--primary-neon);
      background:var(--surface-glass);
      cursor:pointer;
      border:1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter:blur(8px);
      position:relative;
      overflow:hidden;
    }
    #weekTable tbody td::before{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(135deg, var(--primary-neon), var(--primary-purple));
      opacity:0;
      transition:opacity 0.3s ease;
    }
    #weekTable tbody td:hover::before{
      opacity:0.1;
    }
    #weekTable tbody td:hover{
      transform:translateY(-2px) scale(1.05);
      box-shadow:0 8px 32px rgba(0, 255, 136, 0.3);
      border-color:var(--primary-neon);
    }
    #weekTable th{cursor:pointer;}

    .frei{
      background:linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(6, 182, 212, 0.2))!important;
      color:var(--primary-neon)!important;
      border-color:var(--primary-neon)!important;
      box-shadow:0 4px 20px rgba(0, 255, 136, 0.3)!important;
    }
    .gebucht{
      background:linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(239, 68, 68, 0.2))!important;
      color:var(--primary-pink)!important;
      border-color:var(--primary-pink)!important;
      box-shadow:0 4px 20px rgba(236, 72, 153, 0.3)!important;
    }

    /* ---------- Modern Glass Modals ---------- */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(10, 10, 10, 0.8);
      backdrop-filter:blur(8px);
      align-items:center;
      justify-content:center;
      z-index:9999;
      animation:modalFadeIn 0.3s ease;
    }
    @keyframes modalFadeIn{
      from{opacity:0;transform:scale(0.9);}
      to{opacity:1;transform:scale(1);}
    }
    .modal-content{
      background:var(--surface-glass);
      backdrop-filter:blur(20px);
      padding:30px;
      border-radius:20px;
      text-align:center;
      min-width:400px;
      box-shadow:var(--glass-shadow);
      border:var(--glass-border);
      position:relative;
      overflow:hidden;
    }
    .modal-content::before{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(135deg, rgba(0, 255, 136, 0.05), rgba(139, 92, 246, 0.05));
      pointer-events:none;
    }
    .modal-content p{
      color:var(--primary-neon);
      font-weight:600;
      margin-bottom:20px;
      font-size:18px;
    }
    .modal-content label{
      display:inline-block;
      margin-top:15px;
      text-align:left;
      width:100px;
      color:var(--primary-purple);
      font-weight:600;
    }
    .modal-content input[type="date"],.modal-content input[type="text"]{
      width:200px;
      padding:12px;
      border:1px solid rgba(255, 255, 255, 0.2);
      border-radius:12px;
      margin:8px 0;
      background:var(--surface-glass-hover);
      color:var(--primary-neon);
      backdrop-filter:blur(8px);
      transition:all 0.3s ease;
    }
    .modal-content input[type="date"]:focus,.modal-content input[type="text"]:focus{
      outline:none;
      border-color:var(--primary-neon);
      box-shadow:0 0 20px rgba(0, 255, 136, 0.3);
    }
    .modal-content button{
      margin:15px 8px;
      padding:12px 24px;
      font-size:14px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight:600;
      backdrop-filter:blur(8px);
      border:1px solid rgba(255, 255, 255, 0.1);
      position:relative;
      overflow:hidden;
    }
    .modal-content button::before{
      content:'';
      position:absolute;
      inset:0;
      opacity:0;
      transition:opacity 0.3s ease;
    }
    .modal-content button:hover{
      transform:translateY(-2px) scale(1.05);
    }
    #submitBooking{
      background:linear-gradient(135deg, var(--primary-neon), var(--primary-blue));
      color:var(--bg-dark);
      box-shadow:0 4px 20px rgba(0, 255, 136, 0.3);
    }
    #submitBooking::before{
      background:rgba(255, 255, 255, 0.2);
    }
    #submitBooking:hover::before{
      opacity:1;
    }
    #cancelBooking{
      background:linear-gradient(135deg, var(--primary-pink), #ef4444);
      color:white;
      box-shadow:0 4px 20px rgba(236, 72, 153, 0.3);
    }
    #cancelBooking::before{
      background:rgba(255, 255, 255, 0.2);
    }
    #cancelBooking:hover::before{
      opacity:1;
    }

    #errorModal,#deleteModal,#partialDeleteModal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(10, 10, 10, 0.8);
      backdrop-filter:blur(8px);
      align-items:center;
      justify-content:center;
      z-index:10000;
    }
    #errorModal .modal-content,#deleteModal .modal-content,#partialDeleteModal .modal-content{
      background:var(--surface-glass);
      backdrop-filter:blur(20px);
      padding:30px;
      border-radius:20px;
      text-align:center;
      min-width:400px;
      box-shadow:var(--glass-shadow);
      border:var(--glass-border);
    }
    #errorModal button,#deleteModal button,#partialDeleteModal button{
      margin:8px;
      padding:12px 24px;
      border:none;
      border-radius:12px;
      background:linear-gradient(135deg, var(--primary-neon), var(--primary-blue));
      color:var(--bg-dark);
      cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight:600;
      box-shadow:0 4px 20px rgba(0, 255, 136, 0.3);
      border:1px solid rgba(255, 255, 255, 0.1);
    }
    #errorModal button:hover,#deleteModal button:hover,#partialDeleteModal button:hover{
      transform:translateY(-2px) scale(1.05);
      box-shadow:0 8px 32px rgba(0, 255, 136, 0.4);
    }
    #deleteWhole{
      background:linear-gradient(135deg, var(--primary-pink), #ef4444)!important;
      box-shadow:0 4px 20px rgba(236, 72, 153, 0.3)!important;
    }
    #deleteWhole:hover{
      box-shadow:0 8px 32px rgba(236, 72, 153, 0.4)!important;
    }
    #deletePartial{
      background:linear-gradient(135deg, var(--accent-gold), #f97316)!important;
      box-shadow:0 4px 20px rgba(245, 158, 11, 0.3)!important;
    }
    #deletePartial:hover{
      box-shadow:0 8px 32px rgba(245, 158, 11, 0.4)!important;
    }
    #errorText,#deleteText{
      margin-bottom:20px;
      color:var(--primary-neon);
      font-weight:600;
      font-size:16px;
    }
    #partialDeleteModal .dayList{
      text-align:left;
      margin:15px 0;
      max-height:200px;
      overflow-y:auto;
      background:var(--surface-glass-hover);
      border-radius:12px;
      padding:15px;
      border:1px solid rgba(255, 255, 255, 0.1);
    }
    #partialDeleteModal .dayList label{
      display:block;
      margin:8px 0;
      color:var(--primary-purple);
      font-weight:500;
      cursor:pointer;
      transition:color 0.3s ease;
    }
    #partialDeleteModal .dayList label:hover{
      color:var(--primary-neon);
    }
    #partialDeleteModal .dayList input[type="checkbox"]{
      margin-right:10px;
      accent-color:var(--primary-neon);
    }
  </style>
</head>
<body>
  <!-- Header‑Bild -->
  <img src="assets/heuteam.png" alt="Heute am Institut" class="headerImage">

  <!-- Vierecke -->
  <div class="container">
    <svg viewBox="0 0 720 200">
      <defs>
        <linearGradient id="greenGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#00ff88;stop-opacity:1" />
          <stop offset="50%" style="stop-color:#06b6d4;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="redGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#ec4899;stop-opacity:1" />
          <stop offset="50%" style="stop-color:#ef4444;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#f59e0b;stop-opacity:1" />
        </linearGradient>
        <filter id="glow">
          <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
          <feMerge> 
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
      <g class="roomGroup" data-roomid="1.30"><rect x="37"  y="50" width="100" height="100" fill="url(#greenGradient)" rx="8" ry="8" filter="url(#glow)"></rect><text x="87"  y="100" font-size="16" text-anchor="middle">1.30</text></g>
      <g class="roomGroup" data-roomid="1.40-1"><rect x="174" y="50" width="100" height="100" fill="url(#greenGradient)" rx="8" ry="8" filter="url(#glow)"></rect><text x="224" y="100" font-size="16" text-anchor="middle">1.40-1</text></g>
      <g class="roomGroup" data-roomid="1.40-2"><rect x="311" y="50" width="100" height="100" fill="url(#greenGradient)" rx="8" ry="8" filter="url(#glow)"></rect><text x="361" y="100" font-size="16" text-anchor="middle">1.40-2</text></g>
      <g class="roomGroup" data-roomid="1.47-1"><rect x="448" y="50" width="100" height="100" fill="url(#greenGradient)" rx="8" ry="8" filter="url(#glow)"></rect><text x="498" y="100" font-size="16" text-anchor="middle">1.47-1</text></g>
      <g class="roomGroup" data-roomid="1.47-2"><rect x="585" y="50" width="100" height="100" fill="url(#greenGradient)" rx="8" ry="8" filter="url(#glow)"></rect><text x="635" y="100" font-size="16" text-anchor="middle">1.47-2</text></g>
    </svg>
    <div id="preview"></div>
  </div>

  <!-- Pfeil‑/Text‑Bild -->
  <img src="assets/platz.png" alt="Buche dir deinen Platz" class="midImage">

  <!-- Kalender -->
  <div class="calendarWrapper">
    <div class="weekNav">
      <button id="prevWeek">Zurück</button>
      <span id="weekLabel"></span>
      <button id="nextWeek">Weiter</button>
    </div>

    <div class="calendarContainer">
      <table id="weekTable">
        <thead id="tableHeader"></thead>
        <tbody>
          <tr id="row-1.30"><th>1.30</th></tr>
          <tr id="row-1.40-1"><th>1.40-1</th></tr>
          <tr id="row-1.40-2"><th>1.40-2</th></tr>
          <tr id="row-1.47-1"><th>1.47-1</th></tr>
          <tr id="row-1.47-2"><th>1.47-2</th></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal: Buchung anlegen -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <p id="modalText"></p>
      <div><label for="userName">Name:</label><input type="text" id="userName" placeholder="Dein Name"></div>
      <div><label for="startDate">Von:</label><input type="date" id="startDate"></div>
      <div><label for="endDate">Bis:</label><input type="date" id="endDate"></div>
      <br>
      <button id="submitBooking">Buchung absenden</button>
      <button id="cancelBooking">Abbrechen</button>
    </div>
  </div>

  <!-- Fehler‑Modal -->
  <div id="errorModal" class="modal">
    <div class="modal-content">
      <p id="errorText"></p>
      <button id="errorClose">OK</button>
    </div>
  </div>

  <!-- Löschen‑Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <p id="deleteText"></p>
      <button id="deleteWhole">gesamte buchung löschen</button>
      <button id="deletePartial">einzelne tage löschen</button>
      <button id="deleteCancel">abbrechen</button>
    </div>
  </div>

  <!-- Partial‑Delete‑Modal -->
  <div id="partialDeleteModal" class="modal">
    <div class="modal-content">
      <p id="partialDeleteText">Wählen Sie die Tage aus, die gelöscht werden sollen:</p>
      <div id="partialDeleteList" class="dayList"></div>
      <button id="partialDeleteConfirm">löschen</button>
      <button id="partialDeleteCancel">abbrechen</button>
    </div>
  </div>

  <script>
    /* ------------------------------------------------------------------
       Hilfsfunktionen
    ------------------------------------------------------------------ */
    const baseUrl = "assets/";
    const norm = s => (typeof s === "string" ? s.slice(0,10) : s); // Datum auf YYYY‑MM‑DD kürzen
    const weekdaysShort = ["So","Mo","Di","Mi","Do","Fr","Sa"];
    const getWeekdayShort = d => weekdaysShort[d.getDay()];
    const toISODate = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    const formatDateShort = iso => iso.split("-").reverse().join(".").slice(0,6);
    const getLocalToday = () => toISODate(new Date());

    /* ------------------------------------------------------------------
       Globale Variablen
    ------------------------------------------------------------------ */
    let bookings = [];
    let weekStart = null;
    let selectedRoomId = "";
    let currentBookingToDelete = null;
    let previewHideTimeout = null;

    /* ------------------------------------------------------------------
       SVG‑Färbung für HEUTE
    ------------------------------------------------------------------ */
    function updatePlatzColorsSVG(){
      const today = getLocalToday();
      document.querySelectorAll(".roomGroup").forEach(group=>{
        const rect   = group.querySelector("rect");
        const roomId = group.dataset.roomid;
        const booked = bookings.some(b =>
          b.roomId === roomId &&
          norm(b.startDate) <= today &&
          norm(b.endDate)   >= today
        );
        rect.style.fill = booked ? "#FF7597" : "#04F498";
      });
    }

    /* ------------------------------------------------------------------
       Wochen‑Handling
    ------------------------------------------------------------------ */
    const computeMonday = d => {const w = new Date(d);w.setDate(w.getDate() - ((d.getDay()+6)%7));return w;};
    function initWeek(){weekStart = computeMonday(new Date());}

    function changeWeek(n){
      weekStart.setDate(weekStart.getDate() + n*7);
      loadBookings();                   // Daten für neue Woche holen → Header & Tabelle erst danach bauen
    }

    /* ------------------------------------------------------------------
       Header + Tabelle
    ------------------------------------------------------------------ */
    function buildWeekHeader(){
      const header = document.getElementById("tableHeader");
      header.innerHTML = "";
      const trDays  = document.createElement("tr");
      const trDates = document.createElement("tr");

      const thEmpty   = document.createElement("th");
      thEmpty.rowSpan = 2;
      thEmpty.textContent = "Platz/Tag";
      trDays.appendChild(thEmpty);

      for(let i=0;i<5;i++){
        const day   = new Date(weekStart); day.setDate(weekStart.getDate()+i);
        const iso   = toISODate(day);
        const thD   = document.createElement("th"); thD.textContent = getWeekdayShort(day);
        const thIso = document.createElement("th"); thIso.textContent = formatDateShort(iso);

        if(iso === getLocalToday()){thIso.style.background="#fff";thIso.style.color="#000";}
        trDays.appendChild(thD); trDates.appendChild(thIso);
      }
      header.appendChild(trDays); header.appendChild(trDates);

      const end = new Date(weekStart); end.setDate(weekStart.getDate()+4);
      document.getElementById("weekLabel").textContent =
        `${formatDateShort(toISODate(weekStart))} – ${formatDateShort(toISODate(end))}`;
    }

    function autoScaleCellText(){
      document.querySelectorAll("#weekTable td,#weekTable th").forEach(cell=>{
        let fs = parseFloat(getComputedStyle(cell).fontSize);
        while(cell.scrollWidth > cell.clientWidth && fs > 8){fs--;cell.style.fontSize = fs+"px";}
      });
    }

    function fillRow(roomId){
      const row = document.getElementById(`row-${roomId}`);
      while(row.cells.length > 1) row.deleteCell(1);

      for(let i=0;i<5;i++){
        const cell = row.insertCell(-1);
        const day  = new Date(weekStart); day.setDate(weekStart.getDate()+i);
        const iso  = toISODate(day);

        const booking = bookings.find(b =>
          b.roomId === roomId &&
          norm(b.startDate) <= iso &&
          norm(b.endDate)   >= iso
        );

        if(booking){
          cell.textContent = booking.name;
          cell.className = "gebucht";

          cell.onmouseover = () => {cell.dataset.old = cell.textContent;cell.textContent="löschen?";cell.style.background="var(--primary-gray)";};
          cell.onmouseout  = () => {cell.textContent = cell.dataset.old;cell.style.background="";};
          cell.onclick     = () => {currentBookingToDelete = booking;document.getElementById("deleteText").textContent=`Buchung von ${booking.name} löschen?`;document.getElementById("deleteModal").style.display="flex";};
        }else{
          cell.textContent = "frei";
          cell.className = "frei";

          cell.onmouseover = () => {cell.dataset.old = cell.textContent;cell.textContent="buchen?";cell.style.background="var(--primary-green-dark)";};
          cell.onmouseout  = () => {cell.textContent = cell.dataset.old;cell.style.background="";};
          cell.onclick     = () => {selectedRoomId = roomId;document.getElementById("modalText").textContent=`Buchung für ${roomId} am ${formatDateShort(iso)}`;document.getElementById("startDate").value=iso;document.getElementById("endDate").value=iso;document.getElementById("userName").value="";document.getElementById("modal").style.display="flex";};
        }
      }
    }

    function buildWeekTable(){
      ["1.30","1.40-1","1.40-2","1.47-1","1.47-2"].forEach(fillRow);
      autoScaleCellText();
    }

    /* ------------------------------------------------------------------
       Buchungen laden
    ------------------------------------------------------------------ */
    function loadBookings(){
      fetch("http://localhost:7000/bookings")
        .then(r => r.json())
        .then(data => {
          bookings = data;
          buildWeekHeader();
          buildWeekTable();
          updatePlatzColorsSVG();
        })
        .catch(err => console.error("Fehler beim Laden:",err));
    }

    /* ------------------------------------------------------------------
       Preview‑Div für Vierecke
    ------------------------------------------------------------------ */
    const previewDiv = document.getElementById("preview");
    previewDiv.onmouseenter = () => clearTimeout(previewHideTimeout);
    previewDiv.onmouseleave = () => {previewDiv.style.opacity="0";previewHideTimeout = setTimeout(()=>previewDiv.style.display="none",300);};

    document.querySelectorAll(".roomGroup").forEach(group=>{
      const rect = group.querySelector("rect");
      const text = group.querySelector("text");
      const id   = group.dataset.roomid;

      group.onmouseenter = ()=>{
        clearTimeout(previewHideTimeout);
        const img = `${baseUrl}${id}.jpg`;
        previewDiv.innerHTML = `<img src="${img}" style="width:300px;height:300px" alt="Vorschau">`;
        previewDiv.style.display="block";previewDiv.style.opacity="1";

        const contB = document.querySelector(".container").getBoundingClientRect();
        const rectB = rect.getBoundingClientRect();
        previewDiv.style.left = ((rectB.left+rectB.right)/2 - contB.left -150)+"px";
        previewDiv.style.top  = (rectB.bottom - contB.top +5)+"px";

        const isRed = (rect.style.fill||rect.getAttribute("fill")||"").toLowerCase().includes("ff7597");
        const x     = text.getAttribute("x")||0;
        text.innerHTML = isRed
          ? `<tspan x="${x}" dy="0">Leider</tspan><tspan x="${x}" dy="1.2em">heute schon</tspan><tspan x="${x}" dy="1.2em">belegt</tspan>`
          : `<tspan x="${x}" dy="0">Willst du</tspan><tspan x="${x}" dy="1.2em">buchen?</tspan>`;
        group.style.transform="scale(1.1)";
      };

      group.onmouseleave = ()=>{
        previewHideTimeout = setTimeout(()=>{previewDiv.style.opacity="0";setTimeout(()=>previewDiv.style.display="none",300);},300);
        group.style.transform="scale(1)";setTimeout(()=>text.textContent=id,300);
      };

      group.onclick = ()=>{
        if((rect.style.fill||"").toLowerCase().includes("ff7597")) return; // bereits belegt
        selectedRoomId = id;
        const today = getLocalToday();
        document.getElementById("modalText").textContent = `Buchung für ${id} am ${formatDateShort(today)}`;
        document.getElementById("startDate").value = today;
        document.getElementById("endDate").value   = today;
        document.getElementById("userName").value  = "";
        document.getElementById("modal").style.display="flex";
      };
    });

    /* ------------------------------------------------------------------
       Buttons & Modale
    ------------------------------------------------------------------ */
    document.getElementById("prevWeek").onclick      = () => changeWeek(-1);
    document.getElementById("nextWeek").onclick      = () => changeWeek(1);
    document.getElementById("cancelBooking").onclick = () => document.getElementById("modal").style.display="none";
    document.getElementById("errorClose").onclick    = () => document.getElementById("errorModal").style.display="none";
    document.getElementById("deleteCancel").onclick  = () => {currentBookingToDelete=null;document.getElementById("deleteModal").style.display="none";};
    document.getElementById("partialDeleteCancel").onclick = () => document.getElementById("partialDeleteModal").style.display="none";

    /* -- Buchung absenden ---------------------------------------------*/
    document.getElementById("submitBooking").onclick = ()=>{
      const name = document.getElementById("userName").value.trim();
      const s    = document.getElementById("startDate").value;
      const e    = document.getElementById("endDate").value;
      if(!name) {showError("Bitte einen Namen eingeben!");return;}
      if(!s||!e){showError("Bitte Start- und Enddatum wählen!");return;}
      if(e<s)   {showError("Enddatum darf nicht vor dem Startdatum liegen!");return;}

      let conflict=false;
      let cur=new Date(s), end=new Date(e);
      while(cur<=end){
        const iso = toISODate(cur);
        if(bookings.some(b=>b.roomId===selectedRoomId && norm(b.startDate)<=iso && norm(b.endDate)>=iso)){conflict=true;break;}
        cur.setDate(cur.getDate()+1);
      }
      if(conflict){showError("Buchung nicht möglich. Der Platz ist an ausgewählten Tagen bereits belegt!");return;}

      fetch("http://localhost:7000/bookings",{
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({roomId:selectedRoomId,name,startDate:s,endDate:e})
      })
        .then(r=>r.json())
        .then(()=>{document.getElementById("modal").style.display="none";loadBookings();})
        .catch(err=>console.error("Fehler beim Buchen:",err));
    };

    /* -- Löschen gesamter Zeitraum ------------------------------------*/
    document.getElementById("deleteWhole").onclick = ()=>{
      if(!currentBookingToDelete){document.getElementById("deleteModal").style.display="none";return;}
      fetch(`http://localhost:7000/bookings/${currentBookingToDelete.id}`,{method:"DELETE"})
        .then(r=>r.json())
        .then(()=>{currentBookingToDelete=null;document.getElementById("deleteModal").style.display="none";loadBookings();})
        .catch(err=>console.error("Fehler beim Löschen:",err));
    };

    /* -- Lösch‑Modal (einzelne Tage) ----------------------------------*/
    document.getElementById("deletePartial").onclick = ()=>{
      if(!currentBookingToDelete){document.getElementById("deleteModal").style.display="none";return;}
      const list = document.getElementById("partialDeleteList"); list.innerHTML="";
      const start=new Date(currentBookingToDelete.startDate), end=new Date(currentBookingToDelete.endDate);
      for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)){
        const iso = toISODate(d);
        const label=document.createElement("label");
        const cb=document.createElement("input"); cb.type="checkbox";cb.value=iso;
        label.append(cb,` ${formatDateShort(iso)}`); list.appendChild(label);
      }
      document.getElementById("deleteModal").style.display="none";
      document.getElementById("partialDeleteModal").style.display="flex";
    };

    document.getElementById("partialDeleteConfirm").onclick = ()=>{
      const dates=[...document.querySelectorAll('#partialDeleteList input:checked')].map(cb=>cb.value);
      if(!dates.length){showError("Bitte wählen Sie mindestens einen Tag aus!");return;}
      fetch(`http://localhost:7000/bookings/${currentBookingToDelete.id}/split`,{
        method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deleteDates:dates})
      })
        .then(r=>r.json())
        .then(()=>{document.getElementById("partialDeleteModal").style.display="none";loadBookings();})
        .catch(err=>console.error("Fehler beim Splitten:",err));
    };

    /* ------------------------------------------------------------------
       Fehler‑Anzeige
    ------------------------------------------------------------------ */
    const showError = msg => {document.getElementById("errorText").textContent=msg;document.getElementById("errorModal").style.display="flex";};

    /* ------------------------------------------------------------------
       Initialisierung
    ------------------------------------------------------------------ */
    initWeek();
    loadBookings();
  </script>
</body>
</html>
